{% extends 'superior.html' %}
{% load static %}

{% block styles %}
    <script src="{% static 'dispatrace/css/jquery-ui.css' %}"></script>
{% endblock %}


{% block content %}

<section id="container-fluid">
	<div class="mb-2 bg-white d-flex justify-content-start p-2">
		<h4 class="mr-5">Filter Options:</h4>
		<form class="d-flex" method="GET" id="filterOptions" action='{% url "fuel:reports-fuel" %}'>
			<span>
				<div class="d-flex">	
					<select class="mr-2 form-control" name="city" id="cities">
						<option value="None"> ---------- </option>
						{% for option in cities %}
							{% include "_reports/options.html" %}
						{% endfor %}
					</select>
					<select class="mr-2 form-control" name="office" id="offices">
						<option value="None"> ---------- </option>
					</select>
					<select class="mr-2 form-control" name="department" id="departments">
						<option value="None"> ---------- </option>
					</select>
				</div>
				<div class="d-flex mt-2">
					<span class="mr-2 -d-inline">From: <input class=" form-control" type="text" id="datepickerFrom"></span>
					<span class="mr-5">TO: <input class=" form-control" type="text" id="datepickerTo"></span>
				</div>
			</span>
			<input class="btn btn-outline-info" type="submit" value="filter">
		</form>
	</div>
	<div class="chart_agile row">
		<div class="col-md-6 floatcharts_w3layouts_left">
			<div class="floatcharts_w3layouts_top">
				<div class="floatcharts_w3layouts_bottom">
					<div id="graph5"></div>
				</div>
			</div>
		</div>
	</div>
</section>

{% endblock %}


{% block scripts %}
	<script type="text/javascript">
		jQuery(document).ready(function($) {

			var morrisBar;

			initMorris();
			getMorrisOnStrat();

			function initMorris(){
				morrisBar = Morris.Bar({
				  element: 'graph5',
				  xkey: 'x',
				  ykeys: ['diesel', 'petrol'],
				  labels: ['DIESEL', 'PETROL'],
				  stacked: false
				});
			}

			function setMorris(data) {
				morrisBar.setData(data);
			}

			function getMorrisOnStrat() {			
				var tpr = "{{ petrol_requests  | safe | escapejs}}";
				var tdr = "{{ diesel_requests  | safe | escapejs}}";
				var tpa = "{{ petrol_amount_total.pat  | safe | escapejs}}";
				var tda = "{{ diesel_amount_total.dat  | safe | escapejs}}";
				var data = [
					{x: 'TOTAL REQUESTS', diesel: tdr, petrol: tpr},
					{x: 'TOTAL FUEL AMOUNT', diesel: tda, petrol: tpa},
				  ]
				  setMorris(data);
			}

			// Populate Offices by city dependency
			$('select#cities').on('change', function(){
				var city = $(this).val();
				var officeOptions = $('select#offices');
					officeOptions.html('<option value="None"> ---------- </option>');
				var departmentOptions = $('select#departments');
					departmentOptions.html('<option value="None"> ---------- </option>');

				if (city != 'None') {
					$.ajax({
						method: 'GET',
						url: '/profiles/populate',
						data: {
							'city': city,
							'do': 'pop_offices'
						},
						success: function (res) {
							$.each(res.offices, (i, office) => {
								officeOptions.append(
									$("<option />").val(office.name).text(office.name)
								);
							});
						},
						error: function () {},
					});
				}

			});

			// Populate Departments by office depenency
			$('select#offices').on('change', function(){
				var office = $(this).val();
				var departmentOptions = $('select#departments');
					departmentOptions.html('<option value="None"> ---------- </option>');

				if (office != 'None') {
					$.ajax({
						method: 'GET',
						url: '/profiles/populate',
						data: {
							'office': office,
							'city': $('form#filterOptions').find('select#cities').val(),
							'do': 'pop_departments'
						},
						success: function (res) {
							$.each(res.departments, (i, department) => {
								departmentOptions.append(
									$("<option />").val(department.name).text(department.name)
								);
							});
						},
						error: function () {

						},
					});
				}

			});

			// Filter 
			$('form#filterOptions').on('submit', function(e){
		        e.preventDefault();
		        e.stopImmediatePropagation();

				var thisForm = $(this);
				$.ajax({
					method: 'GET',
					url: $(this).attr('action'),
					data: {
						'city': $(this).find('select#cities').val(),
						'office': $(this).find('select#offices').val(),
						'department': $(this).find('select#departments').val(),
						'dateFrom': $(this).find('#datepickerFrom').val(),
						'dateTo': $(this).find('#datepickerTo').val()
					},
					success: function (res) {
						tpr = res.petrol_requests;
						tdr = res.diesel_requests;
						tpa = res.petrol_amount_total.dat;
						if (tpa === null) {tpa = 0;}
						tda = res.diesel_amount_total.dat;
						if (tda === null) {tda = 0;}

						var filtered_data = [
							{x: 'TOTAL REQUESTS', diesel: tdr, petrol: tpr},
							{x: 'TOTAL FUEL AMOUNT', diesel: tda, petrol: tpa},
						  ]
				  		setMorris(filtered_data);
					},
					error: function () {

					},
				});
			});





		});
	</script>	
	<script src="{% static 'dispatrace/js/jquery-ui.js' %}"></script>
	<script>
		  $( function() {
		    $( "#datepickerFrom" ).datepicker();
		    $( "#datepickerTo" ).datepicker();
		  } );
	</script>	
{% endblock %}
